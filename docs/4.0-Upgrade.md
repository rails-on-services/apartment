# Apartment 4.0 Upgrade Guide

This document outlines the breaking changes and upgrade requirements for Apartment 4.0, which introduces a major architectural refactor focused on connection-pool-per-tenant design.

---

## ðŸš¨ Breaking Changes Overview

Apartment 4.0 represents a significant architectural shift that improves performance, thread safety, and Rails compatibility. While the public API remains largely the same, there are important breaking changes to be aware of.

### Minimum Requirements

- **Rails**: 7.1+ (Rails 8.0 recommended)
- **Ruby**: 3.2+ (Ruby 3.3+ recommended)
- **Databases**: PostgreSQL 12+, MySQL 8.0+, SQLite 3.8+

---

## ðŸ—ï¸ Core Architectural Changes

### Connection Pool Management

**Before (3.x):**
```ruby
# Connection switching with search_path manipulation
Apartment::Tenant.switch('tenant1') do
  # SET search_path = 'tenant1' executed on each switch
  User.all
end
```

**After (4.0):**
```ruby
# Dedicated connection pools per tenant
Apartment::Tenant.switch('tenant1') do
  # Uses dedicated pool for tenant1 - zero switching overhead
  User.all
end
```

**Impact**: Zero-overhead tenant switching with dedicated connection pools.

### Thread Safety

**Before (3.x):** Global state with potential race conditions
**After (4.0):** `ActiveSupport::CurrentAttributes` for fiber/thread isolation

---

## ðŸ“ Configuration Changes

### Required: Update `tenants_provider`

**Before (3.x):**
```ruby
Apartment.configure do |config|
  config.tenant_names = lambda { Tenant.pluck(:name) }
  # or
  config.tenant_names = %w[tenant1 tenant2]
end
```

**After (4.0):**
```ruby
Apartment.configure do |config|
  config.tenants_provider = -> { Tenant.active.pluck(:name) }
  # Must be a callable (proc/lambda)
end
```

### Required: Set `tenant_strategy`

**New in 4.0:**
```ruby
Apartment.configure do |config|
  config.tenant_strategy = :schema          # PostgreSQL schema isolation (default)
  # OR
  config.tenant_strategy = :database_name   # MySQL database-per-tenant
  # OR
  config.tenant_strategy = :shard          # Rails native sharding
  # OR
  config.tenant_strategy = :database_config # Custom configurations
end
```

### Optional: Database-Specific Configuration

**PostgreSQL Configuration:**
```ruby
Apartment.configure do |config|
  config.configure_postgres do |pg|
    pg.persistent_schemas = %w[public shared_data]
    pg.enforce_search_path_reset = false
  end
end
```

**MySQL Configuration:**
```ruby
Apartment.configure do |config|
  config.configure_mysql do |mysql|
    # MySQL-specific settings
  end
end
```

---

## ðŸ”„ API Changes

### Removed Methods

| **Removed Method** | **Replacement** | **Notes** |
|-------------------|-----------------|-----------|
| `Apartment::Tenant.current_tenant` | `Apartment::Tenant.current` | Renamed for consistency |
| `Apartment::Tenant.reset!` | `Apartment::Tenant.reset` | Removed bang notation |
| `Apartment.tenant_names` | `Apartment.config.tenants_provider.call` | Dynamic callable approach |

### Deprecated Methods (Still Available)

| **Method** | **Status** | **Migration Path** |
|------------|------------|-------------------|
| `Apartment::Tenant.switch_to` | Deprecated | Use `Apartment::Tenant.switch` |

---

## ðŸ”§ Middleware Updates

### Required: Update Tenant Resolution

**Before (3.x):**
```ruby
class TenantMiddleware
  def call(env)
    tenant = extract_tenant(env)
    Apartment::Tenant.switch_to(tenant)
    @app.call(env)
  ensure
    Apartment::Tenant.reset!
  end
end
```

**After (4.0):**
```ruby
class TenantMiddleware
  def call(env)
    tenant = extract_tenant(env)
    Apartment::Tenant.switch(tenant) do
      @app.call(env)
    end
    # Automatic cleanup - no ensure needed
  end
end
```

**Benefits**: Automatic tenant cleanup and exception safety.

---

## ðŸ§ª Testing Changes

### RSpec Configuration

**Update `rails_helper.rb`:**
```ruby
RSpec.configure do |config|
  config.before(:each) do
    Apartment::Tenant.reset
  end
end
```

### Factory Bot / Fixtures

**Before (3.x):**
```ruby
# Tenant switching in specs
before { Apartment::Tenant.switch_to('test_tenant') }
after { Apartment::Tenant.reset! }
```

**After (4.0):**
```ruby
# Block-scoped tenant switching
it 'tests tenant behavior' do
  Apartment::Tenant.switch('test_tenant') do
    # Test code here
  end
end
```

---

## ðŸ“¦ Background Jobs

### Sidekiq Integration

**Before (3.x):**
```ruby
class TenantJob
  include Sidekiq::Worker

  def perform(tenant, data)
    Apartment::Tenant.switch_to(tenant)
    # Process job
  ensure
    Apartment::Tenant.reset!
  end
end
```

**After (4.0):**
```ruby
class TenantJob
  include Sidekiq::Worker

  def perform(tenant, data)
    Apartment::Tenant.switch(tenant) do
      # Process job - automatic cleanup
    end
  end
end
```

### ActiveJob Integration

**After (4.0):**
```ruby
class TenantJob < ApplicationJob
  def perform(tenant, data)
    Apartment::Tenant.switch(tenant) do
      # Process job
    end
  end
end
```

---

## ðŸ—„ï¸ Database-Specific Migrations

### PostgreSQL Schema Strategy

**Recommended approach for existing apps:**
```ruby
# config/initializers/apartment.rb
Apartment.configure do |config|
  config.tenant_strategy = :schema
  config.tenants_provider = -> { Tenant.active.pluck(:schema_name) }
  config.default_tenant = 'public'

  config.configure_postgres do |pg|
    pg.persistent_schemas = %w[public shared_extensions]
  end
end
```

### MySQL Database Strategy

**For MySQL users:**
```ruby
# config/initializers/apartment.rb
Apartment.configure do |config|
  config.tenant_strategy = :database_name
  config.tenants_provider = -> { Tenant.active.pluck(:database_name) }
  config.default_tenant = Rails.application.class.module_parent_name.underscore
end
```

---

## âš¡ Performance Improvements

### Connection Pool Benefits

- **Zero switching overhead** after initial pool creation
- **Sub-millisecond tenant access** for cached pools
- **Memory efficiency** with pool reuse
- **Thread safety** by design

### Benchmarks

| **Metric** | **3.x** | **4.0** | **Improvement** |
|------------|---------|---------|-----------------|
| Tenant switching | ~2-5ms | <1ms | 2-5x faster |
| Memory per tenant | Variable | ~2MB | Predictable |
| Thread safety | Partial | Complete | 100% safe |

---

## ðŸš€ Migration Checklist

### Pre-Migration

- [ ] Verify Rails 7.1+ and Ruby 3.2+
- [ ] Review existing tenant switching patterns
- [ ] Backup production database
- [ ] Test in staging environment

### During Migration

- [ ] Update `Gemfile` to `apartment ~> 4.0.0.alpha1`
- [ ] Replace `tenant_names` with `tenants_provider`
- [ ] Add `tenant_strategy` configuration
- [ ] Update middleware to use block-scoped switching
- [ ] Update background jobs to use block-scoped switching
- [ ] Update test helpers

### Post-Migration

- [ ] Run full test suite
- [ ] Performance testing with realistic tenant counts
- [ ] Monitor memory usage in production
- [ ] Verify thread safety under load

---

## ðŸ†˜ Troubleshooting

### Common Issues

**"No connection defined for tenant"**
```ruby
# Ensure tenants_provider returns valid tenant names
config.tenants_provider = -> { Tenant.where(active: true).pluck(:name) }
```

**Memory usage concerns**
```ruby
# Each tenant uses ~2MB for connection pool
# 100 active tenants â‰ˆ 200MB additional memory
```

**Thread safety issues**
```ruby
# Always use block-scoped switching
Apartment::Tenant.switch(tenant) do
  # Safe: automatic cleanup
end

# Avoid manual switching in multi-threaded environments
Apartment::Tenant.switch!(tenant)  # Risky without proper cleanup
```

### Performance Monitoring

```ruby
# Monitor connection pool usage
ActiveRecord::Base.connection_handler.connection_pool_names.count

# Monitor per-tenant memory
ObjectSpace.count_objects
```

---

## ðŸ“ž Support

- **GitHub Issues**: [apartment issues](https://github.com/influitive/apartment/issues)
- **Documentation**: See `docs/` directory for detailed guides
- **Migration Help**: Include your configuration and error messages when reporting issues

---

**Migration Timeline Recommendation**: Plan for 1-2 sprint cycles to complete the migration and thorough testing.